<!-- @meta {title="Store"} -->

	<script type="application/javascript">
		if(logiblockSettings)
			logiblockSettings.namingRules["order"] = "Current Order";
		
		function populateOrder(order)
		{
			location.hash = "#" + order.id;
			store.updateCart(order);

			var $table = $("table.order"), $summary = $("tr.summary", $table), $checkoutButton = $("button.checkoutButton"), subtotal = 0;

			$("tr.orderRow", $table).remove();

			var items = Object.keys(order.items);
			for(var i = 0; i < items.length; i++)
			{
				var o = order.items[items[i]];
				subtotal = o.qty * o.price;
				$summary.before($('<tr class="orderRow"><td>' + (i + 1) + '.</td><td><a href="' + o.url + '">' + o.desc + '</a></td><td>' + o.qty + '</td><td>$' + (subtotal / 100) + '</td></tr>'));
			}

			$checkoutButton.html("Buy ($" + (store.getTotal() / 100) + ")");
			if(store.getTotal() <= 0)	$checkoutButton.addClass("disabled");
			else						$checkoutButton.removeClass("disabled");
		}
		
		$.then(function()
		{
			var stripeCheckoutHandler = StripeCheckout.configure(
			{
				key: "pk_test_6pRNASCoBOKtIshFeQd4XMUh",
				image: "/static/logiblock-checkout.png",
				shippingAddress: true,
				token: function(token, args)
				{
					console.log("token()", arguments);

					window.stripeKey = {token: token, address: args};

					storeAPI.checkoutOrder(store.getOrderID(), {token: token, address: args}, function(err, response)
					{
						console.log(err, response);

						//navigate
					});
				}
			});
			
			$("button.checkoutButton").click(function(e)
			{
				if(store.getTotal() > 0)
				{
					stripeCheckoutHandler.open(
					{
						name: "Logiblock Store",
						description: "Cart contents ($" + (store.getTotal() / 100) + ")",
						amount: store.getTotal()
					});
				}
				e.preventDefault();
			});
			


			if(location.hash)
			{
				storeAPI.getOrder(location.hash.substr(1), function(err, order)
				{
					if(err)
						storeAPI.createOrder(function(err, order)
						{
							populateOrder(order);
						});
					else
						populateOrder(order);
				});
			}
			else
				storeAPI.createOrder(function(err, order)
				{
					populateOrder(order);
				});
		});
	</script>
	<script src="https://checkout.stripe.com/checkout.js"></script>
	
	<div class="jumbotron jumbo-white">
		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<table class="table order">
						<tr><th> </th><th>Description</th><th>Qty.</th><th>Subtotal</th></tr>

						<tr class="summary"><td></td><td>Total</td><td></td><td>
							<button class="btn btn-primary btn-lg checkoutButton disabled">Buy</button>
						</td></tr>
					</table>
				</div>
			</div>
		</div>
	</div>
